<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📘 پروژه جامع مشاوره تحصیلی</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Plotly.js for charts (Updated Version) -->
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    
    <!-- Dexie.js for IndexedDB -->
    <script src="https://unpkg.com/dexie@3/dist/dexie.js"></script>

    <!-- Vazirmatn Font for Persian text -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f7f8fc;
            background-image: linear-gradient(to top right, #f7f8fc, #eef1f9);
        }
        /* Custom styles for better UI/UX */
        .card {
            background-color: white;
            border-radius: 16px;
            padding: 2.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
        }
        .btn {
            padding: 0.8rem 1.75rem;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.05rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-primary {
            background-image: linear-gradient(to right, #4f46e5, #7c3aed);
            color: white;
            box-shadow: 0 4px 15px -5px rgba(99, 102, 241, 0.5);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px -5px rgba(99, 102, 241, 0.6);
        }
        .btn-danger {
            background-color: #ef4444; color: white;
        }
        .btn-danger:hover {
             background-color: #dc2626;
        }
        .input-field {
            width: 100%;
            padding: 0.85rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: #f9fafb;
        }
        .input-field:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
        }
        .input-field:disabled {
            background-color: #e5e7eb;
            cursor: not-allowed;
        }
        details > summary {
            cursor: pointer;
            padding: 1.25rem;
            background-color: #f9fafb;
            border-radius: 12px;
            font-weight: 700;
            transition: background-color 0.2s;
        }
         details > summary:hover {
            background-color: #f3f4f6;
        }
        details[open] > summary {
            background-color: #eef2ff;
            color: #4338ca;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        .loader {
            border: 5px solid #e5e7eb;
            border-top: 5px solid #4f46e5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in { animation: fadeInAnimation 0.7s ease-in-out; }
        @keyframes fadeInAnimation {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        #advice-text h2 { font-size: 1.5rem; font-weight: 800; color: #4338ca; margin-top: 2rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #c7d2fe;}
        #advice-text ul { list-style-type: none; padding-right: 0; }
        #advice-text li { position: relative; padding-right: 1.75rem; margin-bottom: 0.75rem; line-height: 1.8; }
        #advice-text li::before { content: '✅'; position: absolute; right: 0; top: 2px; color: #4ade80; }

        /* Chat styles */
        .chat-bubble { max-width: 80%; padding: 0.75rem 1rem; border-radius: 16px; line-height: 1.6; }
        .chat-user { background-color: #eef2ff; color: #3730a3; border-bottom-right-radius: 4px; }
        .chat-assistant { background-color: #f3f4f6; color: #374151; border-bottom-left-radius: 4px; }
        .typing-indicator span { height: 8px; width: 8px; margin: 0 2px; background-color: #a5b4fc; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 50;
        }

    </style>
</head>
<body class=" text-gray-800 p-4 md:p-8">

    <div id="app-container">
        <header class="text-center my-8">
            <h1 class="text-4xl font-extrabold text-gray-800">📘 پروژه جامع مشاوره تحصیلی</h1>
            <p class="text-gray-500 mt-2 text-lg">با کمک هوش مصنوعی، برنامه‌ای شخصی‌سازی شده برای موفقیت خود بسازید</p>
        </header>

        <button id="start-over-btn" class="hidden fixed top-4 left-4 btn bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 z-10">
            <i class="fa-solid fa-arrow-rotate-left"></i>
            شروع مجدد
        </button>

        <div class="max-w-4xl mx-auto">
            <!-- Phase 1: Student Information -->
            <div id="phase1" class="card fade-in">
                <h1 class="text-2xl font-bold text-center mb-2"><i class="fa-solid fa-user-pen text-indigo-500"></i> ثبت اطلاعات دانش‌آموز</h1>
                <p id="welcome-back-msg" class="text-center text-green-600 font-semibold mb-4"></p>
                <form id="student-info-form" class="space-y-4">
                    <div>
                        <label for="national_code" class="block mb-2 font-medium">کد ملی</label>
                        <input type="text" id="national_code" name="national_code" class="input-field" required pattern="\d{10}" title="کد ملی باید ۱۰ رقم باشد">
                    </div>
                    <div>
                        <label for="last_name" class="block mb-2 font-medium">نام خانوادگی</label>
                        <input type="text" id="last_name" name="last_name" class="input-field" required>
                    </div>
                    <button type="submit" id="submit-info-btn" class="w-full btn btn-primary mt-4"><i class="fa-solid fa-check"></i> ثبت اطلاعات</button>
                </form>
                <p id="info-error" class="text-red-500 text-center mt-4"></p>
            </div>

            <!-- Phase 2: Grades and Planning -->
            <div id="phase2" class="hidden">
                <div id="grades-section" class="card">
                    <h1 id="grades-title" class="text-2xl font-bold text-center mb-6"></h1>
                    <div id="grades-container" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 mb-6"></div>
                    <button id="submit-grades-btn" class="w-full btn btn-primary"><i class="fa-solid fa-chart-line"></i> ثبت نمرات و مشاهده نتایج</button>
                </div>
                <div id="chart-section" class="card mt-6 hidden">
                     <h2 class="text-xl font-bold text-center mb-4">نمودار مقایسه نمرات</h2>
                     <div id="plotly-chart"></div>
                </div>
                <div id="planner-section" class="card mt-6 hidden">
                    <h1 class="text-2xl font-bold text-center mb-6"><i class="fa-solid fa-calendar-week text-indigo-500"></i> برنامه‌ریز هفتگی</h1>
                    <p class="text-center text-gray-600 mb-6">برای هر روز هفته، فعالیت‌های ثابت و ساعات آزاد خود را وارد کنید.</p>
                    <div id="weekly-planner-container" class="space-y-4"></div>
                     <div id="planner-progress" class="w-full bg-gray-200 rounded-full h-2.5 mt-6 mb-2">
                        <div class="bg-indigo-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <button id="submit-planner-btn" class="w-full btn btn-primary mt-6"><i class="fa-solid fa-brain"></i> اتمام و دریافت مشاوره پیشرفته</button>
                </div>
            </div>

            <!-- Phase 3: AI Advice Result & Chat -->
            <div id="result-section" class="mt-6 hidden">
                <div id="loader-card" class="card">
                    <div class="loader mx-auto"></div>
                    <p class="mt-4 text-gray-600 font-semibold text-center">در حال ارسال اطلاعات به هوش مصنوعی... ⏳</p>
                    <p class="text-gray-500 text-sm text-center">این فرآیند ممکن است کمی طول بکشد</p>
                </div>
                <div id="ai-advice-card" class="card hidden">
                     <h1 class="text-3xl font-extrabold text-center mb-6 text-green-600">✅ مشاوره شخصی‌سازی‌شده آماده است!</h1>
                     <div id="advice-text" class="prose max-w-none text-right rtl leading-loose bg-gray-50 p-6 rounded-lg border"></div>
                     <div class="flex gap-4 mt-8">
                         <button id="download-advice-btn" class="flex-1 btn btn-primary bg-green-600 hover:bg-green-700"><i class="fa-solid fa-download"></i> دانلود مشاوره</button>
                         <button id="open-chat-btn" class="flex-1 btn bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"><i class="fa-solid fa-comments"></i> بحث و گفتگو درباره برنامه</button>
                     </div>
                </div>
                 <p id="api-error" class="text-red-500 text-center mt-4 font-semibold"></p>
                
                <!-- Chat Container -->
                <div id="chat-container" class="card mt-6 hidden">
                    <h2 class="text-2xl font-bold text-center mb-4">گفتگو با مشاور هوش مصنوعی</h2>
                    <div id="chat-history" class="h-96 overflow-y-auto p-4 bg-gray-50 border rounded-lg mb-4 flex flex-col gap-4"></div>
                     <div id="typing-indicator-container" class="hidden flex items-center justify-start mb-2 ml-2">
                        <div class="typing-indicator"><span></span><span></span><span></span></div>
                    </div>
                    <form id="chat-form" class="flex gap-3">
                        <input type="text" id="chat-input" class="input-field flex-grow" placeholder="پیام خود را بنویسید..." autocomplete="off">
                        <button type="submit" class="btn btn-primary"><i class="fa-solid fa-paper-plane"></i> ارسال</button>
                    </form>
                </div>
            </div>
        </div>
        <footer class="text-center mt-8">
            <a href="#" id="admin-login-link" class="text-sm text-gray-500 hover:text-indigo-600">ورود ادمین</a>
        </footer>
    </div>
    
    <!-- Admin Panel -->
    <div id="admin-panel" class="hidden max-w-5xl mx-auto p-4 md:p-8">
        <div class="card">
            <div class="flex justify-between items-center mb-6">
                 <h1 class="text-3xl font-bold text-gray-800"><i class="fa-solid fa-user-shield text-indigo-500"></i> پنل مدیریت دانش‌آموزان</h1>
                 <button id="admin-logout-btn" class="btn bg-red-500 text-white hover:bg-red-600"><i class="fa-solid fa-right-from-bracket"></i> خروج</button>
            </div>
            <div class="mb-4">
                <input type="text" id="admin-search-input" class="input-field" placeholder="جستجو بر اساس نام یا کد ملی...">
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="py-3 px-4 text-right font-semibold text-gray-600">ID</th>
                            <th class="py-3 px-4 text-right font-semibold text-gray-600">نام خانوادگی</th>
                            <th class="py-3 px-4 text-right font-semibold text-gray-600">کد ملی</th>
                            <th class="py-3 px-4 text-center font-semibold text-gray-600">عملیات</th>
                        </tr>
                    </thead>
                    <tbody id="admin-student-table-body">
                        <!-- Student data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="modal-overlay hidden">
        <div class="card w-full max-w-sm fade-in">
            <h2 class="text-2xl font-bold text-center mb-6">ورود به پنل ادمین</h2>
            <form id="admin-login-form" class="space-y-4">
                <div>
                    <label for="admin-username" class="block mb-2 font-medium">نام کاربری</label>
                    <input type="text" id="admin-username" class="input-field" required value="admin">
                </div>
                <div>
                    <label for="admin-password" class="block mb-2 font-medium">رمز عبور</label>
                    <input type="password" id="admin-password" class="input-field" required>
                </div>
                <button type="submit" class="w-full btn btn-primary">ورود</button>
            </form>
            <p id="admin-login-error" class="text-red-500 text-center mt-4"></p>
            <button id="close-login-modal-btn" class="w-full text-center text-gray-500 mt-4 hover:text-gray-700">بستن</button>
        </div>
    </div>


    <script>
        // --- Database Setup (Dexie.js) ---
        const db = new Dexie('academicAdvisorDB');
        db.version(1).stores({
            students: '++id, &nationalCode, lastName' // Primary key, Unique index, Regular index
        });

        // --- Global State & Constants ---
        const initialState = {
            lastName: '', nationalCode: '', reportCard: '', finalPlan: '', aiAdvice: '',
            chatHistory: [], initialPrompt: '', isExistingUser: false
        };
        let state = { ...initialState };

        const API_KEY = "API_KEY";
        const API_URL = "https://openrouter.ai/api/v1/chat/completions";

        const subjects = { "دین و زندگی۱": 2, "عربی، زبان قرآن۱": 2, "فارسی۱": 2, "نگارش۱": 2, "فیزیک۱": 4, "شیمی۱": 3, "ریاضی۱": 4, "هندسه۱": 2, "آمادگی دفاعی": 2, "آزمایشگاه علوم تجربی۱": 2, "جغرافیای عمومی و استان شناسی": 2, "تربیت بدنی": 2, "تفکر و سواد رسانه‌ای": 2, "انضباط": 2, "انگلیسی۱": 3 };
        const daysOfWeek = ["شنبه", "یکشنبه", "دوشنبه", "سه‌شنبه", "چهارشنبه", "پنج‌شنبه", "جمعه"];

        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const adminPanel = document.getElementById('admin-panel');
        const phase1Div = document.getElementById('phase1');
        const phase2Div = document.getElementById('phase2');
        const resultSection = document.getElementById('result-section');
        const startOverBtn = document.getElementById('start-over-btn');
        // Phase 1 elements
        const studentInfoForm = document.getElementById('student-info-form');
        const lastNameInput = document.getElementById('last_name');
        const nationalCodeInput = document.getElementById('national_code');
        const submitInfoBtn = document.getElementById('submit-info-btn');
        const infoErrorP = document.getElementById('info-error');
        const welcomeBackMsg = document.getElementById('welcome-back-msg');
        // Other elements
        const gradesSection = document.getElementById('grades-section');
        const chartSection = document.getElementById('chart-section');
        const plannerSection = document.getElementById('planner-section');
        const loaderCard = document.getElementById('loader-card');
        const aiAdviceCard = document.getElementById('ai-advice-card');
        const chatContainer = document.getElementById('chat-container');
        const chatHistoryDiv = document.getElementById('chat-history');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const typingIndicator = document.getElementById('typing-indicator-container');
        // Admin elements
        const adminLoginLink = document.getElementById('admin-login-link');
        const adminLoginModal = document.getElementById('admin-login-modal');
        const adminLoginForm = document.getElementById('admin-login-form');
        const closeLoginModalBtn = document.getElementById('close-login-modal-btn');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        const adminStudentTableBody = document.getElementById('admin-student-table-body');
        const adminSearchInput = document.getElementById('admin-search-input');


        // --- UI Control ---
        function showPhase(phaseId) {
            [phase1Div, phase2Div, resultSection].forEach(div => div.classList.add('hidden'));
            const targetDiv = document.getElementById(phaseId);
            if (targetDiv) {
                targetDiv.classList.remove('hidden');
                targetDiv.classList.add('fade-in');
            }
            startOverBtn.classList.toggle('hidden', phaseId === 'phase1');
        }

        startOverBtn.addEventListener('click', () => {
            state = { ...initialState };
            studentInfoForm.reset();
            lastNameInput.disabled = false;
            welcomeBackMsg.textContent = '';
            infoErrorP.textContent = '';
            submitInfoBtn.innerHTML = '<i class="fa-solid fa-check"></i> ثبت اطلاعات';
            [gradesSection, chartSection, plannerSection, resultSection, aiAdviceCard, chatContainer].forEach(el => el.classList.add('hidden'));
            document.getElementById('plotly-chart').innerHTML = '';
            loaderCard.style.display = 'block';
            showPhase('phase1');
        });

        // --- Phase 1: Student Info & DB Interaction ---
        nationalCodeInput.addEventListener('input', async (e) => {
            const code = e.target.value;
            welcomeBackMsg.textContent = '';
            infoErrorP.textContent = '';
            lastNameInput.value = '';
            state.isExistingUser = false;
            lastNameInput.disabled = false;
            submitInfoBtn.innerHTML = '<i class="fa-solid fa-check"></i> ثبت اطلاعات';
            if (code.length === 10) {
                try {
                    const student = await db.students.get({ nationalCode: code });
                    if (student) {
                        state.isExistingUser = true;
                        lastNameInput.value = student.lastName;
                        lastNameInput.disabled = true;
                        welcomeBackMsg.textContent = `خوش آمدید ${student.lastName}! اطلاعات شما پیدا شد.`;
                        submitInfoBtn.innerHTML = '<i class="fa-solid fa-arrow-right-to-bracket"></i> ادامه با اطلاعات موجود';
                    }
                } catch (error) {
                    console.error("Database lookup failed:", error);
                    infoErrorP.textContent = "خطا در بررسی اطلاعات.";
                }
            }
        });

        studentInfoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            infoErrorP.textContent = '';
            const nationalCode = nationalCodeInput.value;
            const lastName = lastNameInput.value;

            if (!/^\d{10}$/.test(nationalCode)) {
                infoErrorP.textContent = 'کد ملی باید دقیقاً ۱۰ رقم باشد.'; return;
            }
            if (!lastName) {
                infoErrorP.textContent = 'نام خانوادگی نمی‌تواند خالی باشد.'; return;
            }

            state.nationalCode = nationalCode; state.lastName = lastName;
            if (!state.isExistingUser) {
                try {
                    await db.students.add({ nationalCode, lastName });
                } catch (error) {
                    infoErrorP.textContent = error.name === 'ConstraintError' ? 'این کد ملی قبلاً ثبت شده است.' : 'خطا در ذخیره اطلاعات.';
                    console.error("Database add failed:", error);
                    return;
                }
            }
            showPhase('phase2');
            gradesSection.classList.remove('hidden');
            gradesSection.classList.add('fade-in');
            document.getElementById('grades-title').innerHTML = `<i class="fa-solid fa-graduation-cap text-indigo-500"></i> ورود نمرات برای <strong class="text-indigo-600">${state.lastName}</strong>`;
            populateGradesInputs();
        });

        function populateGradesInputs() {
            const container = document.getElementById('grades-container');
            container.innerHTML = '';
            const allowedScores = Array.from({length: 81}, (_, i) => (i * 0.25).toFixed(2));
            Object.keys(subjects).forEach(subject => {
                const div = document.createElement('div');
                div.innerHTML = `<label class="block mb-1 text-sm font-medium">${subject}:</label><select id="score-${subject}" class="input-field"></select>`;
                const select = div.querySelector('select');
                allowedScores.forEach(score => {
                    const option = document.createElement('option');
                    option.value = score; option.textContent = score;
                    if (parseFloat(score) === 15.0) option.selected = true;
                    select.appendChild(option);
                });
                container.appendChild(div);
            });
        }
        
        // --- Phase 2: Grades & Planner ---
        document.getElementById('submit-grades-btn').addEventListener('click', () => {
            const userScores = {};
            let totalWeighted = 0;
            const totalUnits = Object.values(subjects).reduce((a, b) => a + b, 0);
            Object.keys(subjects).forEach(subject => {
                const score = parseFloat(document.getElementById(`score-${subject}`).value);
                userScores[subject] = score;
                totalWeighted += score * subjects[subject];
            });
            const weightedAverage = (totalWeighted / totalUnits).toFixed(2);
            const classAvg = {};
            Object.keys(subjects).forEach(subject => classAvg[subject] = (Math.random() * 3 + 17).toFixed(2));
            Plotly.newPlot('plotly-chart', [{ x: Object.keys(subjects), y: Object.values(userScores), name: '🎓 نمره شما', type: 'bar', marker: { color: '#4f46e5' } }, { x: Object.keys(subjects), y: Object.values(classAvg), name: '🏫 میانگین کلاس', type: 'bar', marker: { color: '#10b981' } }], { barmode: 'group', xaxis: { tickangle: -45, automargin: true }, yaxis: { title: 'نمره', range: [0, 20] }, plot_bgcolor: 'rgba(0,0,0,0)', paper_bgcolor: 'rgba(0,0,0,0)', font: { family: 'Vazirmatn, sans-serif' }, legend: { x: 0.5, xanchor: 'center', y: -0.4, orientation: 'h' } }, {responsive: true});
            
            let reportText = `دانش آموز: ${state.lastName}\nکد ملی: ${state.nationalCode}\n\nنمرات شما:\n`;
            for (const [s, score] of Object.entries(userScores)) reportText += `${s}: ${score}\n`;
            reportText += `\nمعدل وزنی: ${weightedAverage}\n\nمیانگین نمرات کلاس:\n`;
            for (const [s, avg] of Object.entries(classAvg)) reportText += `${s}: ${avg}\n`;
            state.reportCard = reportText;
            gradesSection.classList.add('hidden');
            chartSection.classList.remove('hidden'); chartSection.classList.add('fade-in');
            plannerSection.classList.remove('hidden'); plannerSection.classList.add('fade-in');
            populateWeeklyPlanner();
        });
        
        function populateWeeklyPlanner() {
            const container = document.getElementById('weekly-planner-container');
            container.innerHTML = '';
            daysOfWeek.forEach((day, index) => {
                const details = document.createElement('details');
                if (index < 2) details.open = true;
                details.innerHTML = `<summary class="text-lg font-medium flex justify-between items-center"><span><i class="fa-solid fa-calendar-day ml-2 text-indigo-400"></i>${day}</span><i class="fa-solid fa-chevron-down transition-transform duration-300"></i></summary><div class="p-4 border-t"><label class="block mb-2 font-medium">فعالیت‌های ثابت</label><textarea id="plans-${day}" class="input-field h-24" placeholder="مثال: ساعت ۸ تا ۱۴ مدرسه"></textarea><label class="block mt-4 mb-2 font-medium">زمان آزاد</label><div class="flex items-center gap-4"><input type="number" id="hour-${day}" class="input-field" min="0" max="24" value="4" placeholder="ساعت"><input type="number" id="minute-${day}" class="input-field" step="15" min="0" max="45" value="0" placeholder="دقیقه"></div></div>`;
                container.appendChild(details);
            });
            updatePlannerProgress();
            container.addEventListener('input', updatePlannerProgress);
        }

        function updatePlannerProgress() {
            let filledDays = daysOfWeek.filter(day => document.getElementById(`plans-${day}`).value.trim() || document.getElementById(`hour-${day}`).value > 0).length;
            document.querySelector('#planner-progress > div').style.width = `${(filledDays / daysOfWeek.length) * 100}%`;
        }

        document.getElementById('submit-planner-btn').addEventListener('click', () => {
            let content = "";
            daysOfWeek.forEach(day => {
                const plans = document.getElementById(`plans-${day}`).value.trim().split('\n').filter(Boolean);
                const hour = parseInt(document.getElementById(`hour-${day}`).value) || 0;
                const minute = parseInt(document.getElementById(`minute-${day}`).value) || 0;
                content += `🔸 ${day}:\n`;
                if (plans.length > 0) { content += "🔹 فعالیت‌ها:\n"; plans.forEach(plan => content += `    - ${plan}\n`);} 
                else { content += " ⚠️ هیچ فعالیتی وارد نشده\n"; }
                content += `⏰ زمان آزاد: ${hour} ساعت و ${minute} دقیقه\n\n`;
            });
            state.finalPlan = content;
            getAIAdvice();
        });

        // --- Phase 3: AI Advice & Chat Logic ---
        function buildInitialPrompt(reportCard, weeklyPlan) {
             return `شما یک مشاور تحصیلی بسیار متخصص، همدل و مدرن هستید. هدف شما طراحی یک **برنامه هفتگی کاملاً شخصی‌سازی‌شده** برای هر دانش‌آموز است.\n\n**داده‌های ورودی:**\n${reportCard}\n${weeklyPlan}\n\n**ساختار پاسخ الزامی (با همین تیترها):**\n- **تحلیل جامع وضعیت دانش‌آموز:**\n- **نکات انگیزشی و توصیه‌ها:**\n- **برنامه هفتگی کاملاً شخصی‌سازی شده:**\n- **پیشنهادات بلندمدت بهبود:**\n- **جملات پایانی انگیزشی:**\n\n**نکات مهم:**\n- پاسخ باید کاملاً انسانی و انگیزشی باشد.\n- از لیست‌های نشانه‌دار (با -) برای خوانایی بهتر استفاده کنید.`;
        }
        
        function parseAIResponse(text) {
             let html = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const keywords = ['تحلیل جامع وضعیت دانش‌آموز', 'نکات انگیزشی و توصیه‌ها', 'برنامه هفتگی کاملاً شخصی‌سازی شده', 'پیشنهادات بلندمدت بهبود', 'جملات پایانی انگیزشی'];
            keywords.forEach(keyword => {
                html = html.replace(new RegExp(`(${keyword.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'g'), `<h2>$1</h2>`);
            });
            html = html.replace(/^\s*[-*]\s+(.*)/gm, '<li>$1</li>').replace(/\n/g, '<br>');
            return html.replace(/<br\s*\/?>\s*<(ul|h2|li)/g, '<$1').replace(/<\/(ul|h2|li)>\s*<br\s*\/?>/g, '</$1>');
        }

        async function getAIAdvice() {
            phase2Div.classList.add('hidden');
            showPhase('result-section');
            state.initialPrompt = buildInitialPrompt(state.reportCard, state.finalPlan);
            try {
                const response = await fetch(API_URL, {
                    method: 'POST', headers: { 'Authorization': `Bearer ${API_KEY}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: "openai/gpt-4o-mini", messages: [{ role: "user", content: state.initialPrompt }], temperature: 0.7 })
                });
                if (!response.ok) throw new Error(`خطای شبکه: ${response.status} - ${response.statusText}`);
                const data = await response.json();
                state.aiAdvice = data.choices[0].message.content;
                state.chatHistory = [{ role: "user", content: state.initialPrompt }, { role: "assistant", content: state.aiAdvice }];
                loaderCard.style.display = 'none';
                aiAdviceCard.classList.remove('hidden');
                aiAdviceCard.classList.add('fade-in');
                document.getElementById('advice-text').innerHTML = parseAIResponse(state.aiAdvice);
            } catch (error) {
                console.error("API Error:", error);
                loaderCard.style.display = 'none';
                document.getElementById('api-error').textContent = `❌ خطا در دریافت پاسخ: ${error.message}. لطفاً دوباره تلاش کنید.`;
            }
        }

        document.getElementById('open-chat-btn').addEventListener('click', () => {
            chatContainer.classList.remove('hidden');
            chatContainer.classList.add('fade-in');
            document.getElementById('open-chat-btn').classList.add('hidden');
            chatInput.focus();
        });
        
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;
            state.chatHistory.push({ role: "user", content: userMessage });
            renderChatHistory();
            chatInput.value = '';
            typingIndicator.classList.remove('hidden');
            try {
                const response = await fetch(API_URL, {
                    method: 'POST', headers: { 'Authorization': `Bearer ${API_KEY}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: "openai/gpt-4o-mini", messages: state.chatHistory, temperature: 0.7 })
                });
                if (!response.ok) throw new Error(`خطای شبکه: ${response.status}`);
                const data = await response.json();
                const assistantMessage = data.choices[0].message.content;
                state.chatHistory.push({ role: "assistant", content: assistantMessage });
                state.aiAdvice = assistantMessage;
                document.getElementById('advice-text').innerHTML = parseAIResponse(state.aiAdvice);
                renderChatHistory();
            } catch (error) {
                console.error("Chat Error:", error);
                state.chatHistory.push({ role: "assistant", content: `متاسفانه مشکلی پیش آمد: ${error.message}` });
                renderChatHistory();
            } finally {
                typingIndicator.classList.add('hidden');
            }
        });

        function renderChatHistory() {
            chatHistoryDiv.innerHTML = '';
            const conversationalHistory = state.chatHistory.slice(2);
            conversationalHistory.forEach(msg => {
                const isUser = msg.role === 'user';
                const bubble = document.createElement('div');
                bubble.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
                bubble.innerHTML = `<div class="chat-bubble ${isUser ? 'chat-user' : 'chat-assistant'}"></div>`;
                bubble.querySelector('div').textContent = msg.content;
                chatHistoryDiv.appendChild(bubble);
            });
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
        }

        document.getElementById('download-advice-btn').addEventListener('click', () => {
             const blob = new Blob([state.aiAdvice], { type: 'text/plain;charset=utf-8' });
             const url = URL.createObjectURL(blob);
             const a = document.createElement('a');
             a.href = url;
             a.download = `AI_advice_for_${state.lastName}.txt`;
             document.body.appendChild(a); a.click(); document.body.removeChild(a);
             URL.revokeObjectURL(url);
        });

        // --- Admin Panel Logic ---
        adminLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            adminLoginModal.classList.remove('hidden');
        });

        closeLoginModalBtn.addEventListener('click', () => {
            adminLoginModal.classList.add('hidden');
        });

        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            const errorP = document.getElementById('admin-login-error');
            
            if (username === 'admin' && password === 'Ariom1') {
                errorP.textContent = '';
                adminLoginModal.classList.add('hidden');
                appContainer.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                adminPanel.classList.add('fade-in');
                await loadAdminData();
            } else {
                errorP.textContent = 'نام کاربری یا رمز عبور اشتباه است.';
            }
        });

        adminLogoutBtn.addEventListener('click', () => {
            adminPanel.classList.add('hidden');
            appContainer.classList.remove('hidden');
            startOverBtn.click(); // Reset the app to its initial state
        });
        
        async function loadAdminData(searchTerm = '') {
            try {
                let students;
                if (searchTerm) {
                    students = await db.students
                        .where('lastName').startsWithIgnoreCase(searchTerm)
                        .or('nationalCode').startsWith(searchTerm)
                        .toArray();
                } else {
                    students = await db.students.toArray();
                }
                
                adminStudentTableBody.innerHTML = ''; // Clear table
                if (students.length === 0) {
                    adminStudentTableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">هیچ دانش‌آموزی یافت نشد.</td></tr>';
                    return;
                }

                students.forEach(student => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="py-3 px-4">${student.id}</td>
                        <td class="py-3 px-4">${student.lastName}</td>
                        <td class="py-3 px-4">${student.nationalCode}</td>
                        <td class="py-3 px-4 text-center">
                            <button class="btn btn-danger text-sm py-1 px-3 delete-student-btn" data-id="${student.id}">
                                <i class="fa-solid fa-trash"></i> حذف
                            </button>
                        </td>
                    `;
                    adminStudentTableBody.appendChild(row);
                });

                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-student-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const studentId = parseInt(e.currentTarget.dataset.id);
                        if (confirm(`آیا از حذف این دانش‌آموز با ID ${studentId} مطمئن هستید؟`)) {
                            await db.students.delete(studentId);
                            await loadAdminData(adminSearchInput.value); // Refresh table
                        }
                    });
                });

            } catch (error) {
                console.error("Failed to load admin data:", error);
                adminStudentTableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">خطا در بارگذاری اطلاعات.</td></tr>';
            }
        }
        
        adminSearchInput.addEventListener('input', (e) => {
            loadAdminData(e.target.value.trim());
        });

        // Initialize view
        showPhase('phase1');
    </script>
</body>
</html>
